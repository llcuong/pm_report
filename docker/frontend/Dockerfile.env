FROM node:22-slim AS deps
WORKDIR /opt/env/work

# 1. Nâng npm để tránh bug optionalDependencies
RUN npm install -g npm@11.6.2

# 2. Copy package metadata
COPY frontend/package.json frontend/package-lock.json ./

# 3. Cài node_modules sạch cho Linux
RUN rm -rf node_modules package-lock.json \
 && npm install \
 && npm cache clean --force

# 4. Tách dev / prod node_modules
RUN mkdir -p /opt/env/dev /opt/env/prod \
 && cp -a node_modules /opt/env/dev/node_modules \
 && npm prune --omit=dev \
 && cp -a node_modules /opt/env/prod/node_modules


# =========================
# Env image cuối
# =========================
FROM node:22-slim AS env
WORKDIR /opt/env

COPY --from=deps /opt/env/dev  ./dev
COPY --from=deps /opt/env/prod ./prod

RUN useradd -m appuser
